
Процедура КоманднаяПанель1Выбрать(Кнопка)
	ТекущиеДанные = ЭлементыФормы.ДеревоГрупп.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;  
	Закрыть(ТекущиеДанные.Ключ);
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	ПостроитьДеревоГрупп();
	Если КлючТекущейГруппы <> 0 Тогда
		
		ТекущаяГруппа = ОбработкаОбъект.ПолучитьАлгоритмПоКлючу(КлючТекущейГруппы);
		Если ТекущаяГруппа <> Неопределено Тогда
			
			ТекущаяСтрока = НайтиВДеревеАлгоритм(ТекущаяГруппа);
			ЭлементыФормы.ДеревоГрупп.ТекущаяСтрока = ТекущаяСтрока;
			
		КонецЕсли; 
			
	КонецЕсли; 
КонецПроцедуры

Процедура ПостроитьДеревоГрупп()
	
	КартинкаГрупп = ЭлементыФормы.ДеревоГрупп.Колонки.Наименование.КартинкиСтрок;
	
	ДеревоГрупп = ОбработкаОбъект.ПостроитьДеревоАлгоритмов(Истина, Истина);
	//ОставляемыеКолонки = "Наименование, Ключ";
	А = ДеревоГрупп.Колонки.Количество() - 1;
	Пока А >= 0 Цикл
		
		Если ДеревоГрупп.Колонки[А].Имя <> "Наименование" И ДеревоГрупп.Колонки[А].Имя <> "Ключ" Тогда
			
			ДеревоГрупп.Колонки.Удалить(А);
			
		КонецЕсли; 
		
		А = А-1;
		
	КонецЦикла; 
	
	ЭлементыФормы.ДеревоГрупп.СоздатьКолонки();
	  	
	КолонкаКлюч = ЭлементыФормы.ДеревоГрупп.Колонки.Ключ;
	КолонкаКлюч.Видимость = Ложь;
	КолонкаКлюч.ИзменятьВидимость = Ложь;      
	
	КолонкаНаименование = ЭлементыФормы.ДеревоГрупп.Колонки.Наименование;
	КолонкаНаименование.Видимость = Истина;
	КолонкаНаименование.ТолькоПросмотр = Истина;
	КолонкаНаименование.ИзменятьВидимость = Ложь;
	КолонкаНаименование.КартинкиСтрок = КартинкаГрупп;
	КолонкаНаименование.ОтображатьИерархию = Истина;      
		
КонецПроцедуры

Функция НайтиВДеревеАлгоритм(Алгоритм) 
	
	ТекущийУровень = ДеревоГрупп.Строки[0].Строки;	
	СтрокаРодитель = ДеревоГрупп.Строки[0];  
	
	ПрерватьЦикл = Ложь;
	Пока ТекущийУровень.Количество() <> 0 Цикл
		
		СледующийУровень = Новый Массив(); 
		
		Для Каждого СтрокаДерева Из ТекущийУровень Цикл
			
			Если СтрокаДерева.Ключ = Алгоритм.КлючРодителя Тогда
				
				СтрокаРодитель = СтрокаДерева;
				ПрерватьЦикл = Истина;
				Прервать;
				
			КонецЕсли; 
			
			Если НЕ ПрерватьЦикл Тогда
				
				Для Каждого СтрокаДерева1 Из СтрокаДерева.Строки Цикл
					
					СледующийУровень.Добавить(СтрокаДерева1);
					
				КонецЦикла;
				
			КонецЕсли; 
			
		КонецЦикла; 
		
		ТекущийУровень = СледующийУровень;
		
	КонецЦикла;  	
	
	АлгоритмСтр = Неопределено;
	
	Для Каждого СтрокаДерева Из СтрокаРодитель.Строки Цикл
		
		Если СтрокаДерева.Ключ = Алгоритм.Ключ Тогда
			
			АлгоритмСтр = СтрокаДерева;
			Прервать;
			
		КонецЕсли; 
		
	КонецЦикла;
	
	Возврат АлгоритмСтр;
	
КонецФункции


Процедура ДеревоГруппВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	ТекущиеДанные = ЭлементыФормы.ДеревоГрупп.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;  
	Закрыть(ТекущиеДанные.Ключ)
КонецПроцедуры
